<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (c) 2000, 2025, Oracle and/or its affiliates.

  Licensed under the Universal Permissive License v 1.0 as shown at
  https://oss.oracle.com/licenses/upl.
  -->

<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>com.oracle.coherence.ce</groupId>
    <artifactId>main</artifactId>
    <version>${revision}</version>
    <relativePath>../pom.xml</relativePath>
  </parent>

  <artifactId>coherence-native</artifactId>
  <packaging>jar</packaging>
  <name>Coherence GraalVM Native Image</name>

  <properties>
    <useModulePath>false</useModulePath>
    <bedrockUseModules>false</bedrockUseModules>
  </properties>

  <dependencies>
    <dependency>
      <groupId>${coherence.group.id}</groupId>
      <artifactId>coherence</artifactId>
    </dependency>
    <dependency>
      <groupId>${coherence.group.id}</groupId>
      <artifactId>coherence-grpc-proxy</artifactId>
    </dependency>
    <dependency>
      <groupId>${coherence.group.id}</groupId>
      <artifactId>coherence-json</artifactId>
    </dependency>

    <dependency>
      <groupId>org.glassfish</groupId>
      <artifactId>jakarta.json</artifactId>
      <classifier>module</classifier>
    </dependency>

    <!-- tracing dependencies -->
    <dependency>
      <groupId>io.opentelemetry</groupId>
      <artifactId>opentelemetry-sdk-extension-autoconfigure</artifactId>
    </dependency>
    <dependency>
      <groupId>io.opentelemetry</groupId>
      <artifactId>opentelemetry-exporter-otlp</artifactId>
      <exclusions>
        <exclusion>
          <groupId>com.squareup.okhttp3</groupId>
          <artifactId>okhttp</artifactId>
        </exclusion>
      </exclusions>
    </dependency>
    <!--
       Added due to https://github.com/open-telemetry/opentelemetry-java/issues/7491.
       This should be resolved in a future release at which point this can be removed.
      -->
    <dependency>
      <groupId>com.squareup.okhttp3</groupId>
      <artifactId>okhttp-jvm</artifactId>
    </dependency>

    <!-- slf4j -->
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-simple</artifactId>
    </dependency>

    <dependency>
      <groupId>${coherence.group.id}</groupId>
      <artifactId>coherence-testing-support</artifactId>
      <version>${project.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>${coherence.group.id}</groupId>
      <artifactId>coherence-bedrock-testing-support</artifactId>
      <version>${project.version}</version>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter-api</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter-params</artifactId>
      <scope>test</scope>
    </dependency>

    <dependency>
      <groupId>org.hamcrest</groupId>
      <artifactId>hamcrest-all</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.mockito</groupId>
      <artifactId>mockito-core</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>net.bytebuddy</groupId>
      <artifactId>byte-buddy</artifactId>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>net.bytebuddy</groupId>
      <artifactId>byte-buddy-agent</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-failsafe-plugin</artifactId>
        <configuration>
          <skip>true</skip>
        </configuration>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <configuration>
          <skip>true</skip>
        </configuration>
      </plugin>
    </plugins>
  </build>

  <profiles>
      <profile>
          <id>native</id>
          <activation>
              <activeByDefault>false</activeByDefault>
          </activation>
          <build>
              <plugins>
                  <plugin>
                      <groupId>org.graalvm.buildtools</groupId>
                      <artifactId>native-maven-plugin</artifactId>
                      <extensions>true</extensions>
                      <executions>
                          <execution>
                              <id>build-native</id>
                              <goals>
                                  <goal>compile-no-fork</goal>
                              </goals>
                              <phase>package</phase>
                              <configuration>
                                  <skip>${skip.native.build}</skip>
                                  <mainClass>com.tangosol.net.Coherence</mainClass>
                                  <quickBuild>true</quickBuild>
                                  <imageName>coherence</imageName>
                                  <buildArgs>
                                      <buildArg>-march=native</buildArg>
                                      <buildArg>--future-defaults=all</buildArg>
                                      <buildArg>--emit</buildArg>
                                      <buildArg>build-report</buildArg>
                                      <buildArg>-J-Xmx45g</buildArg>
                                      <buildArg>-H:+UnlockExperimentalVMOptions</buildArg>
                                      <buildArg>-H:+UseConservativeUnsafeAccess</buildArg>
                                      <!-- Required for using http e.g. metrics, management, etc... -->
                                      <buildArg>--enable-http</buildArg>
                                      <buildArg>--enable-https</buildArg>
                                      <!-- Required for tests that use JMX -->
                                      <buildArg>--enable-monitoring=jmxserver,jmxclient,jvmstat</buildArg>
                                      <!-- Required for tests that add -XX:+HeapDumpOnOutOfMemoryError -->
                                      <buildArg>--enable-monitoring=heapdump</buildArg>
                                      <!-- Required to generate thread dumps in a native image -->
                                      <buildArg>--enable-monitoring=threaddump</buildArg>
                                      <!-- Required for tests that use JFRs, for example, management tests -->
                                      <buildArg>--enable-monitoring=jfr</buildArg>
                                      <!-- This is to capture a JFR of the native image compiler; it may break tests -->
                                      <!-- <buildArg>-J-XX:StartFlightRecording=dumponexit=true</buildArg>  -->
                                  </buildArgs>
                              </configuration>
                          </execution>
                      </executions>
                  </plugin>
              </plugins>
          </build>
      </profile>
  </profiles>
</project>
